<!DOCTYPE html><html lang="en"><meta charset="utf-8">
<body>
<pre id="log"></pre>
<p><input type="text" id="input"></p>
<p>Username: <input type="text" id="username"></p>
<script type="module">
import {joinRoom, selfId} from 'https://esm.run/trystero';
const room = joinRoom({appId: 'yellowscreen.neocities.org'}, 'testing');
const [sendMessage, getMessage] = room.makeAction('message');
const [sendRename, getRename] = room.makeAction('rename');

function log(text) {
	const node = document.createTextNode(text + '\n');
	document.getElementById("log").appendChild(node);
}

const names = {};
function get_name(id) {
	if(id in names) return names[id];
	return id;
}

room.onPeerJoin(peerId => log(`* ${get_name(peerId)} joined`));
room.onPeerLeave(peerId => log(`* ${get_name(peerId)} left`));
getMessage((data, peerId) => { log(`<${get_name(peerId)}> ${data}`) });

getRename((data, peerId) => {
	log(`* ${get_name(peerId)} changed name to ${data}`);
	names[peerId] = data;
});

document.getElementById("input").addEventListener('keydown', async function(e) {
	if(e.key === 'Enter') {
		await sendMessage(document.getElementById("input").value);
		log(`<${get_name(selfId)}> ${document.getElementById("input").value}`);
		document.getElementById("input").value = "";
	}
});
document.getElementById("username").addEventListener('keydown', function(e) {
	if(e.key === 'Enter') {
		sendRename(document.getElementById("username").value);
		log(`* ${get_name(selfId)} changed name to ${document.getElementById("username").value}`);
		names[selfId] = document.getElementById("username").value;
	}
});

log(`* ${selfId} joined`);
document.getElementById("username").value = selfId;

window.joinRoom = joinRoom;
window.sendMessage = sendMessage;
window.sendRename = sendRename;
</script>
